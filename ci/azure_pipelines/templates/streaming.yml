# This template includes the steps of the streaming test job in travix.yml

steps:
- bash: |
    echo Running install phase of the original travis.yml

    # Set some variables to make the system looks like Travis
    source $BUILD_SOURCESDIRECTORY/ci/azure_pipelines/templates/travis-legacy/pre-install.sh

    # Start Original script

    # install part
    python $TRAVIS_BUILD_DIR/ci/travis/determine_tests_to_run.py
    eval `python $TRAVIS_BUILD_DIR/ci/travis/determine_tests_to_run.py`
    if [[ $RAY_CI_STREAMING_PYTHON_AFFECTED != "1" && $RAY_CI_STREAMING_JAVA_AFFECTED != "1" ]]; then exit; fi
    ./ci/travis/install-bazel.sh
    # Originally with ./ci/suppress_output
    ./ci/travis/install-dependencies.sh
    export PATH="$HOME/miniconda/bin:$PATH"
    # Originally with ./ci/suppress_output
    ./ci/travis/install-ray.sh

    # script part
    # Streaming cpp test.
    # Originally with ./ci/suppress_output
    if [ $RAY_CI_STREAMING_CPP_AFFECTED == "1" ]; then bazel test //streaming:all && bash streaming/src/test/run_streaming_queue_test.sh; fi
    if [ $RAY_CI_STREAMING_PYTHON_AFFECTED == "1" ]; then python -m pytest -v --durations=5 --timeout=300 streaming/python/tests/; fi
    if [ $RAY_CI_STREAMING_JAVA_AFFECTED == "1" ]; then ./streaming/java/test.sh; fi

      # End Original script

    exit 0
  env:
    PYTHONWARNINGS: 'ignore'
    TRAVIS: 'true'
    RAY_INSTALL_JAVA: 1
    TESTSUITE: streaming
  displayName: 'Run original streaming job'
  timeoutInMinutes: 120
