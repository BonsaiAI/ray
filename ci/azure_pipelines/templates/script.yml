# This template includes the steps of the general script phase
# that is specified in the .travis.yml of the upstream repo.
# This is the default script phase that is reused by some of the
# parallel jobs in the build matrix of the .travis.yml file.
# Tips:
# - TRAVIS_BUILD_DIR got replaced by BUILD_SOURCESDIRECTORY
steps:
- bash: |
    echo Running script phase of the original travis.yml

    # Cause the script to exit if a single command fails.
    set -e

    # TODO: [CI] remove after CI get stable
    set -x

    # Set some variables to make the system looks like Travis
    source $BUILD_SOURCESDIRECTORY/ci/azure_pipelines/templates/travis-legacy/pre-install.sh

    # Start Original script

    . ./ci/travis/ci.sh preload

    # raylet integration tests
    # Originally with ./ci/suppress_output
    bash src/ray/test/run_core_worker_tests.sh
    # Originally with ./ci/suppress_output
    bash src/ray/test/run_object_manager_tests.sh

    # cc bazel tests (w/o RLlib)
    # Originally with ./ci/suppress_output
    bazel test --config=ci --build_tests_only --show_progress_rate_limit=100 --test_output=errors -- //:all -rllib/...

    # ray serve tests
    # Desabling this tests because is not working in ADO and is not required yet in Bonsai
    # Originally with ./ci/keep_alive
    # if [ $RAY_CI_SERVE_AFFECTED == "1" ]; then bazel test --config=ci --test_tag_filters=-jenkins_only python/ray/serve/...; fi

    # ray operator tests
    cd ./deploy/ray-operator/
    CC=gcc go build
    CC=gcc go test ./...
    cd ../..

    # random python tests TODO(ekl): these should be moved to bazel
    # The following is the original line but it was modified
    # because --timeout is not a valid parameter for pytest
    # if [ $RAY_CI_PYTHON_AFFECTED == "1" ]; then python -m pytest -v --durations=5 --timeout=300 python/ray/experimental/test/async_test.py; fi
    if [ $RAY_CI_PYTHON_AFFECTED == "1" ]; then python -m pytest -v --durations=5 python/ray/experimental/test/async_test.py; fi

    # bazel python tests. This should be run last to keep its logs at the end of travis logs.
    # Originally with ./ci/keep_alive
    if [ $RAY_CI_PYTHON_AFFECTED == "1" ]; then bazel test --config=ci --test_tag_filters=-jenkins_only python/ray/tests/...; fi
    # Originally with ./ci/keep_alive
    if [ $RAY_CI_TUNE_AFFECTED == "1" ]; then bazel test --config=ci --test_tag_filters=-jenkins_only python/ray/tune/...; fi
    # NO MORE TESTS BELOW, keep them above.
    # End Original script

    exit 0
  env:
    PYTHONWARNINGS: 'ignore'
    RAY_DEFAULT_BUILD: 1
    RAY_CYTHON_EXAMPLES: 1
    TRAVIS: 'true'
  displayName: 'Run original script phase'
  timeoutInMinutes: 120
