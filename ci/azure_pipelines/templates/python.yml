# This template includes the basic steps needed for
# setting up python in different jobs. The version
# of python to use is expected in the environment
# variable python.version
steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '$(python.version)'
  displayName: 'Use Python $(python.version)'
- script: |
    python -m pip install --upgrade pip
    pip install pytest pytest-azurepipelines
    pip install wheel
    pip install twine
  displayName: 'Install dependencies'
- script: |
    set -xe
    echo "BUILD_BUILDID: $BUILD_BUILDID"
    VERSION_SUFIX="$(echo $BUILD_BUILDID | sed -E 's/[- ]/_/g')"
    echo "VERSION_SUFIX: $VERSION_SUFIX"
    VERSION_FILE="$BUILD_SOURCESDIRECTORY/python/ray/__init__.py"
    if [[ $AGENT_OS == "Darwin" ]]; then 
      sed -i -e -E "s+__version__ = (['\"])([^'\"]*)(['\"])+__version__ = \1\2$VERSION_SUFIX\3+1" $VERSION_FILE
    else
      sed -ier "s+__version__ = \(['\"]\)\([^'\"]*\)\(['\"]\)+__version__ = \1\2$VERSION_SUFIX\3+1" $VERSION_FILE
    fi
    cat $BUILD_SOURCESDIRECTORY/python/ray/__init__.py | grep "__version__ ="
  displayName: 'Change version of Ray to use'
