# This template includes the steps of the general install phase
# that is specified in the .travis.yml of the upstream repo.
# This is the default install phase that is reused by some of the
# parallel jobs in the build matrix of the .travis.yml file.

steps:
- bash: |
    echo Running install phase of the original travis.yml

    # Set some variables to make the system looks like Travis
    source $BUILD_SOURCESDIRECTORY/ci/azure_pipelines/templates/travis-legacy/pre-install.sh

    # Start Original script
    eval `python $TRAVIS_BUILD_DIR/ci/travis/determine_tests_to_run.py`
    if [ $RAY_CI_TUNE_AFFECTED != "1" ] && [ $RAY_CI_RLLIB_AFFECTED != "1" ] && [ $RAY_CI_PYTHON_AFFECTED != "1" ]; then exit; fi

    # Originally with ./ci/suppress_output
    ./ci/travis/install-bazel.sh
    # Originally with ./ci/suppress_output
    ./ci/travis/install-dependencies.sh
    export PATH="$HOME/miniconda/bin:$PATH"
    # Originally with ./ci/suppress_output
    ./ci/travis/install-ray.sh
    # Originally with ./ci/suppress_output
    ./ci/travis/install-cython-examples.sh

    # Originally with ./ci/suppress_output
    bash src/ray/test/run_gcs_tests.sh
    # stats test.
    # Originally with ./ci/suppress_output
    bazel build //:stats_test -c opt
    ./bazel-bin/stats_test

    # Raylet tests.
    # Originally with ./ci/suppress_output
    bash src/ray/test/run_object_manager_tests.sh
    # Originally with ./ci/suppress_output
    bazel test --build_tests_only --test_lang_filters=cc //:all
    # Shutdown bazel to release the memory held by bazel.
    bazel shutdown
    # End Original script

    exit 0
  env:
    PYTHONWARNINGS: 'ignore'
    TRAVIS: 'true'
  displayName: 'Run original travis install phase'
  timeoutInMinutes: 60
