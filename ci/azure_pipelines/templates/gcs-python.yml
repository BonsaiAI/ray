# This template includes the steps of the GCS python job in travix.yml

steps:
- bash: |
    echo Running install phase of the original travis.yml

    # Set some variables to make the system looks like Travis
    source $BUILD_SOURCESDIRECTORY/ci/azure_pipelines/templates/travis-legacy/pre-install.sh

    # Start Original script

    # install part
    eval `python $TRAVIS_BUILD_DIR/ci/travis/determine_tests_to_run.py`
    ./ci/travis/install-bazel.sh
    # Originally with ./ci/suppress_output
    ./ci/travis/install-dependencies.sh
    export PATH="$HOME/miniconda/bin:$PATH"
    # Originally with ./ci/suppress_output
    ./ci/travis/install-ray.sh
    # Originally with ./ci/suppress_output
    ./ci/travis/install-cython-examples.sh
    eval "$(curl -sL https://raw.githubusercontent.com/travis-ci/gimme/master/gimme | GIMME_GO_VERSION=master bash)"
    # script part
    export PATH="$HOME/miniconda/bin:$PATH"
    # Originally with ./ci/keep_alive
    # The original flaky_test_attempts was 3 increasing to 4 because failure rate found in ADO
    bazel test --spawn_strategy=local --flaky_test_attempts=5 --nocache_test_results --test_verbose_timeout_warnings --progress_report_interval=100 --show_progress_rate_limit=100 --show_timestamps --test_output=errors --test_tag_filters=-jenkins_only python/ray/tests/...

      # End Original script

    exit 0
  env:
    PYTHONWARNINGS: 'ignore'
    TRAVIS: 'true'
    RAY_INSTALL_JAVA: 1
    TESTSUITE: gcs_service_python_testcase
    RAY_GCS_SERVICE_ENABLED: true
  displayName: 'Run original GCS python job'
  timeoutInMinutes: 120
